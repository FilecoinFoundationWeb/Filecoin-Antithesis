name: Run Antithesis Test

on: 
  schedule:
    # midnight EST
    - cron: '0 2 * * *'
  #manual run
  workflow_dispatch:
    inputs:
      duration:
        type: string
        required: true
        default: '1'
        description: Duration to the test run
      emails:
        type: string
        required: true
        description: Email receipents
      run_type:
        type: choice
        description: Type of run
        options: 
        - normal
        - no_faults

jobs:
  manual_run:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: antithesishq/antithesis-trigger-action@v0.6
        with:
          notebook_name: forest
          tenant: cobalt-bunny
          username: filecoin
          password: ${{ secrets.ANTITHESIS_PASSWORD }}
          github_token: ${{ secrets.GH_PAT }}
          images: drand:latest;forest:latest;lotus:latest;workload:latest
          config_image: config:latest
          description: "Running the latest container images"
          email_recipients: ${{ github.event.inputs.emails }}
          # test_name: Filecoin localnet (latest)
          additional_parameters: |-
            custom.duration=${{ github.event.inputs.duration }}
            custom.run_type=${{ github.event.inputs.run_type }}
            antithesis.integrations.slack.callback_url=https://hooks.slack.com/services/TEHTVS1L6/B07TJ2GA07J
            antithesis.integrations.slack.token=${{ secrets.SLACK_TOKEN_FOREST }}

  # Todo: build latest forest before run
  scheduled_run:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: antithesishq/antithesis-trigger-action@v0.6
        with:
          notebook_name: forest
          tenant: cobalt-bunny
          username: filecoin
          password: ${{ secrets.ANTITHESIS_PASSWORD }}
          github_token: ${{ secrets.GH_PAT }}
          images: drand:latest;forest:latest;lotus:latest;workload:latest
          config_image: config:latest
          description: "Nightly Filecoin continuous testing"
          email_recipients: "filecoin-notifications.0607b605acbba4a098334f1cf7aad48b.show-sender.prefer-html@streams.zulipchat.com"
          # test_name: Filecoin localnet (latest)
          additional_parameters: |-
            custom.duration=10
            custom.run_type=normal
            antithesis.integrations.slack.callback_url=https://hooks.slack.com/services/TEHTVS1L6/B07TJ2GA07J
            antithesis.integrations.slack.token=${{ secrets.SLACK_TOKEN_FOREST }}
