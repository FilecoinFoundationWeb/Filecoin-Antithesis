name: filecoin
x-templates:
  filecoin_service: &filecoin_service
    env_file: .env
    volumes:
      - ./data/lotus0:${LOTUS_0_DATA_DIR}
      - ./data/forest0:${FOREST_0_DATA_DIR}
      - ./data/lotus1:${LOTUS_1_DATA_DIR}
      - ./shared/configs:${SHARED_CONFIGS}
      - ./data/curio:${CURIO_DATA_DIR}
      - ./data/workload:/opt/antithesis/filwizard/workspace:rw
  needs_drand0_started: &needs_drand0_started
    depends_on:
      drand0:
        condition: service_started

services:
  drand0:
    <<: [*filecoin_service]
    container_name: drand0
    image: drand
    entrypoint: ./start-drand0.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND0_IP}
    healthcheck:
      test: drand util ping http://10.20.20.21:8080
      interval: 5s
      timeout: 2s
      retries: 10

  drand1:
    <<: [*filecoin_service, *needs_drand0_started]
    container_name: drand1
    image: drand
    entrypoint: ./start-drand1.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND1_IP}
    healthcheck:
      test: drand util ping http://10.20.20.22:8080
      interval: 5s
      timeout: 2s
      retries: 10

  drand2:
    <<: [*filecoin_service, *needs_drand0_started]
    container_name: drand2
    image: drand
    entrypoint: ./start-drand2.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND2_IP}
    healthcheck:
      test: drand util ping http://10.20.20.23:8080
      interval: 5s
      timeout: 2s
      retries: 10

  lotus0:
    <<: [*filecoin_service]
    container_name: lotus0
    image: lotus:latest
    entrypoint: ["./scripts/start-lotus.sh", "0"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_0_IP}
    depends_on:
      drand0: 
        condition: service_healthy
      drand1:
        condition: service_healthy
      drand2:
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.24:1234/health/livez
      start_period: 20s
      interval: 5s
      timeout: 2s
      retries: 10

  lotus1:
    <<: [*filecoin_service]
    image: lotus:latest
    container_name: lotus1
    entrypoint: ["./scripts/start-lotus.sh", "1"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_1_IP}
    depends_on:
      lotus0: 
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.26:1235/health/livez
      start_period: 30s
      interval: 5s
      timeout: 2s
      retries: 10

  lotus-miner0:
    <<: [*filecoin_service]
    image: lotus:latest
    container_name: lotus-miner0
    ports:
      - ${LOTUS_MINER_0_RPC_PORT}:${LOTUS_MINER_0_RPC_PORT}
    restart: on-failure
    entrypoint: ["./scripts/start-lotus-miner.sh", "0"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_MINER_0_IP}
    depends_on:
      lotus0: 
        condition: service_healthy

  lotus-miner1:
    <<: [*filecoin_service]
    image: lotus:latest
    container_name: lotus-miner1
    ports:
      - ${LOTUS_MINER_1_RPC_PORT}:${LOTUS_MINER_1_RPC_PORT}
    restart: on-failure
    entrypoint: ["./scripts/start-lotus-miner.sh", "1"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_MINER_1_IP}
    depends_on:
      lotus1: 
        condition: service_healthy

  forest0:
    <<: [*filecoin_service]
    image: forest:latest
    container_name: forest0
    ports:
      - ${FOREST_0_RPC_PORT}:${FOREST_0_RPC_PORT}
    entrypoint: ["./scripts/start-forest.sh"]
    networks:
      antithesis-net:
        ipv4_address: ${FOREST_0_IP}
    depends_on:
      lotus0: 
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.28:2346/livez?verbose
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 30s


  workload:
    <<: [*filecoin_service]
    image: workload
    container_name: workload
    networks:
      antithesis-net:
        ipv4_address: 10.20.20.30
    depends_on:
      lotus1:
        condition: service_healthy
  # Curio service
  curio:
    <<: [*filecoin_service]
    image: curio:latest
    container_name: curio
    env_file:
      - .env
    environment:
      - CURIO_IP=${CURIO_IP}
    ports:
      - "443:443"
      - "80:80"
      - "12300:12300"
      - "4701:4701"
      - "32100:32100"
    entrypoint: ["./scripts/curio-init.sh"]
    networks:
      antithesis-net:
        ipv4_address: ${CURIO_IP}
    depends_on:
      lotus0:
        condition: service_healthy
      yugabyte:
        condition: service_started
  yugabyte:
    image: yugabytedb/yugabyte:latest
    container_name: yugabyte
    init: true
    command: [ "bin/yugabyted", "start", "--base_dir=/home/yugabyte/yb_data", "--background=false" ]
    ports:
      - "5433:5433"
      - "9042:9042"
      - "15433:15433"
    environment:
      - TINI_SUBREAPER=true
    env_file:
      - .env
    volumes:
      - ./data/yugabyte:/home/yugabyte/yb_data
    networks:
      antithesis-net:
        ipv4_address: ${YUGABYTE_IP}

networks:
  antithesis-net:
    ipam:
      config:
        - subnet: 10.20.20.0/24