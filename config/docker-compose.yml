name: filecoin
x-templates:
  filecoin_service: &filecoin_service
    env_file: .env
    volumes:
      - ./data/lotus-1:${LOTUS_1_DATA_DIR}
      - ./data/forest:${FOREST_DATA_DIR}
      - ./data/lotus-2:${LOTUS_2_DATA_DIR}
      - ./shared/configs:${SHARED_CONFIGS}
  setup_genesis: &setup_genesis
    entrypoint: ["./scripts/setup-genesis.sh", "1"]

services:
  drand0:
    <<: [*filecoin_service]
    container_name: drand0
    image: drand:${DRAND_TAG:-latest}
    entrypoint: ./start-drand0.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND_1_IP}
    healthcheck:
      test: drand util ping http://10.20.20.21:8080
      interval: 5s
      timeout: 2s
      retries: 10

  drand1:
    <<: [*filecoin_service]
    container_name: drand1
    image: drand:${DRAND_TAG:-latest}
    entrypoint: ./start-drand1.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND_2_IP}
    depends_on:
      drand0: 
        condition: service_started
    healthcheck:
      test: drand util ping http://10.20.20.22:8080
      interval: 5s
      timeout: 2s
      retries: 10

  drand2:
    <<: [*filecoin_service]
    container_name: drand2
    image: drand:${DRAND_TAG:-latest}
    entrypoint: ./start-drand2.sh
    networks:
      antithesis-net:
        ipv4_address: ${DRAND_3_IP}
    depends_on:
      drand0: 
        condition: service_started
    healthcheck:
      test: drand util ping http://10.20.20.23:8080
      interval: 5s
      timeout: 2s
      retries: 10

  lotus-1:
    <<: [*filecoin_service, *setup_genesis]
    container_name: lotus-1
    image: lotus:${LOTUS_TAG:-latest}
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_1_IP}
    depends_on:
      drand0: 
        condition: service_healthy
      drand1:
        condition: service_healthy
      drand2:
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.24:1234/health/livez
      start_period: 20s
      interval: 5s
      timeout: 2s
      retries: 10

  lotus-miner-1:
    <<: [*filecoin_service]
    image: lotus:${LOTUS_TAG:-latest}
    container_name: lotus-miner-1
    ports:
      - ${LOTUS_MINER_1_RPC_PORT}:${LOTUS_MINER_1_RPC_PORT}
    restart: on-failure
    entrypoint: ["./scripts/lotus-miner-1.sh"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_MINER_1_IP}
    depends_on:
      lotus-1: 
        condition: service_healthy
   
  lotus-2:
    <<: [*filecoin_service]
    image: lotus:${LOTUS_TAG:-latest}
    container_name: lotus-2
    entrypoint: ["./scripts/lotus.sh", "2"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_2_IP}
    depends_on:
      lotus-1: 
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.26:1235/health/livez
      start_period: 30s
      interval: 5s
      timeout: 2s
      retries: 10

  lotus-miner-2:
    <<: [*filecoin_service]
    image: lotus:${LOTUS_TAG:-latest}
    container_name: lotus-miner-2
    ports:
      - ${LOTUS_MINER_2_RPC_PORT}:${LOTUS_MINER_2_RPC_PORT}
    restart: on-failure
    entrypoint: ["./scripts/lotus-miner-2.sh"]
    networks:
      antithesis-net:
        ipv4_address: ${LOTUS_MINER_2_IP}
    depends_on:
      lotus-2: 
        condition: service_healthy

  forest:
    <<: [*filecoin_service]
    image: forest:${FOREST_COMMIT:-latest}
    container_name: forest
      # - ./forest/forest_config.toml.tpl:/forest/forest_config.toml.tpl
      # - ./forest/start_scripts/forest-init.sh:${FOREST_DATA_DIR}/forest-init.sh
    ports:
      - ${FOREST_RPC_PORT}:${FOREST_RPC_PORT}    
    entrypoint: ["${FOREST_DATA_DIR}/forest-init.sh"]
    networks:
      antithesis-net:
        ipv4_address: ${FOREST_IP}
    depends_on:
      lotus-2: 
        condition: service_healthy
    healthcheck:
      test: curl --fail http://10.20.20.28:2346/livez?verbose
      interval: 5s
      timeout: 2s
      retries: 10
      start_period: 30s

  workload:
    <<: [*filecoin_service]
    image: workload:latest
    container_name: workload
    networks:
      antithesis-net:
        ipv4_address: 10.20.20.30
    depends_on:
      lotus-2:
        condition: service_healthy

networks:
  antithesis-net:
    ipam:
      config:
        - subnet: 10.20.20.0/24